<div class="dashboard-container">
  <header class="welcome-section">
    <div class="welcome-text">
      <h1 class="welcome-title">Console d'Administration</h1>
      <p class="welcome-subtitle">Tableau de bord général | <strong>{{ user()?.name }}</strong></p>
    </div>
    <div class="date-display">
      <i class="fa-regular fa-calendar-check"></i>
      <span>{{ today | date:'dd MMMM yyyy':'':'fr' }}</span>
    </div>
  </header>

  <div class="stats-grid">
    <div class="stat-card card-blue" routerLink="/admin/quotes">
      <div class="stat-icon"><i class="fa-solid fa-file-invoice-dollar"></i></div>
      <div class="stat-content">
        <span class="label">Devis en attente</span>
        <span class="value">{{ stats().activeQuotes }}</span>
      </div>
      <div class="card-arrow"><i class="fa-solid fa-chevron-right"></i></div>
    </div>

    <div class="stat-card card-purple" routerLink="/admin/admin-orders">
      <div class="stat-icon"><i class="fa-solid fa-box-open"></i></div>
      <div class="stat-content">
        <span class="label">Commandes actives</span>
        <span class="value">{{ stats().pendingOrders }}</span>
      </div>
      <div class="card-arrow"><i class="fa-solid fa-chevron-right"></i></div>
    </div>

    <div class="stat-card card-green" routerLink="/admin/reports">
      <div class="stat-icon"><i class="fa-solid fa-chart-line"></i></div>
      <div class="stat-content">
        <span class="label">Chiffre d'Affaires</span>
        <span class="value">{{ stats().totalRevenue | number:'1.0-0' }}</span>
        <span class="sub">FCFA validés</span>
      </div>
    </div>

    <div class="stat-card card-red" [class.pulse]="stats().inventoryAlerts > 0" routerLink="/admin/materials">
      <div class="stat-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
      <div class="stat-content">
        <span class="label">Alertes Stock</span>
        <span class="value">{{ stats().inventoryAlerts }}</span>
      </div>
      <div class="card-arrow"><i class="fa-solid fa-chevron-right"></i></div>
    </div>
  </div>

  <div class="main-card">
    <div class="card-header">
      <div class="header-title">
        <i class="fa-solid fa-clock-rotate-left"></i>
        <h2>Activités Récentes</h2>
      </div>
      
      <div class="filter-group">
        <button [class.active]="filterStatus() === 'all'" (click)='setFilter("all")'>Tout</button>
        <button [class.active]="filterStatus() === 'pending'" (click)='setFilter("pending")'>En attente</button>
        <button [class.active]="filterStatus() === 'completed'" (click)='setFilter("completed")'>Terminés</button>
        <button [class.active]="filterStatus() === 'alert'" (click)='setFilter("alert")'>Alertes</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="dashboard-table">
        <thead>
          <tr>
            <th class="type-column">Flux</th>
            <th>Référence</th>
            <th>Détails du projet</th>
            <th>Client</th>
            <th>Date & Heure</th>
            <th>Statut</th>
            <th class="text-right">Montant</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          @if (isLoading()) {
            <tr>
              <td colspan="8" class="loading-state">
                <i class="fa-solid fa-circle-notch fa-spin"></i>
                <p>Synchronisation des données en cours...</p>
              </td>
            </tr>
          } @else {
            @for (item of paginatedActivities(); track item.id + item.action) {
              <tr [class.row-alert]="item.status === 'alert'">
                <td class="type-column">
                  <span class="icon-wrapper" [ngClass]="item.action">
                    <i [class]="item.action === 'quote' ? 'fa-solid fa-file-lines' : 'fa-solid fa-truck-fast'"></i>
                  </span>
                </td>
                <td><span class="ref-badge">{{ item.reference }}</span></td>
                <td>
                  <div class="details-cell">
                    <span class="main-text">{{ item.details }}</span>
                    <span class="sub-text">{{ item.action === 'quote' ? 'Demande de devis' : 'Commande directe' }}</span>
                  </div>
                </td>
                <td>
                  <div class="user-info">
                    <i class="fa-regular fa-circle-user"></i>
                    <span>{{ item.user }}</span>
                  </div>
                </td>
                <td>
                  <div class="date-container">
                    <span class="date-text">{{ item.date | date:'dd/MM/yyyy' }}</span>
                    <span class="time-text">{{ item.date | date:'HH:mm' }}</span>
                  </div>
                </td>
                <td>
                  <span class="status-badge" [ngClass]="'status-' + item.status">
                    {{ item.status === 'pending' ? 'En attente' : item.status === 'completed' ? 'Terminé' : 'Annulé' }}
                  </span>
                </td>
                <td class="text-right">
                  <strong class="amount-text">{{ item.amount | number:'1.0-0' }} FCFA</strong>
                </td>
                <td class="text-center">
                  <div class="action-menu-container">
                    <button class="btn-dots" (click)="toggleMenu($event, item.id)">
                      <i class="fa-solid fa-ellipsis-vertical"></i>
                    </button>
                    
                    @if (activeMenuId() === item.id) {
                      <div class="dropdown-menu">
                        <a [routerLink]="item.action === 'quote' ? ['/admin/quotes', item.id] : ['/admin/admin-orders', item.id]">
                          <i class="fa-solid fa-magnifying-glass"></i>
                          <span>Consulter</span>
                        </a>
                        <a href="mailto:{{ item.user_email }}" *ngIf="item.user_email">
                          <i class="fa-solid fa-envelope"></i>
                          <span>Contacter</span>
                        </a>
                      </div>
                    }
                  </div>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="8" class="empty-state">
                  <i class="fa-solid fa-inbox"></i>
                  <p>Aucune activité enregistrée pour cette catégorie.</p>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>

    @if (totalPages() > 1) {
      <div class="pagination-bar">
        <span class="page-info">Page <strong>{{ currentPage() }}</strong> sur {{ totalPages() }}</span>
        
        <div class="pagination-controls">
          <button class="btn-nav" [disabled]="currentPage() === 1" (click)="goToPage(currentPage() - 1)">
            <i class="fa-solid fa-chevron-left"></i>
          </button>

          <div class="page-numbers">
            @for (p of pagesArray(); track p) {
              <button class="page-num" [class.active]="p === currentPage()" (click)="goToPage(p)">
                {{ p }}
              </button>
            }
          </div>

          <button class="btn-nav" [disabled]="currentPage() === totalPages()" (click)="goToPage(currentPage() + 1)">
            <i class="fa-solid fa-chevron-right"></i>
          </button>
        </div>
      </div>
    }
  </div>
</div>