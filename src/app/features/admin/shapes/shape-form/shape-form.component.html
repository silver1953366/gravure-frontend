<div class="shape-form-container">
  <header class="form-header">
    <button type="button" class="btn-back" (click)="router.navigate(['/admin/shapes'])" title="Retour à la liste">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="icon-sm">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
      </svg>
    </button>
    <div>
      <h2>{{ isEditMode ? 'Modifier la Forme' : 'Nouvelle Forme' }}</h2>
      <p class="subtitle">Définissez les caractéristiques visuelles et techniques de la forme.</p>
    </div>
  </header>

  @if (isLoading && isEditMode) {
    <div class="loading-state-container">
      <div class="spinner"></div>
      <p>Récupération des données...</p>
    </div>
  } @else {
    <form [formGroup]="shapeForm" (ngSubmit)="onSubmit()" class="modern-form">
      
      @if (error) {
        <div class="alert-error">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="icon-sm">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
          {{ error }}
        </div>
      }

      <div class="form-grid">
        <div class="form-group">
          <label for="name">Nom de la Forme *</label>
          <input 
            id="name" 
            type="text" 
            formControlName="name" 
            placeholder="Ex: Rectangle arrondi"
            [class.error-field]="shapeForm.get('name')?.invalid && shapeForm.get('name')?.touched">
          @if (shapeForm.get('name')?.invalid && shapeForm.get('name')?.touched) {
            <span class="error-msg">Le nom est obligatoire (max 100 caractères).</span>
          }
        </div>

        <div class="form-group">
          <label for="slug">Slug (Identifiant URL) *</label>
          <div class="slug-input-wrapper">
            <input 
              id="slug" 
              type="text" 
              formControlName="slug" 
              placeholder="ex-rectangle-arrondi"
              [class.locked]="isSlugLocked">
            <button type="button" (click)="toggleSlugLock()" class="btn-lock-toggle" [class.is-locked]="isSlugLocked">
              @if (isSlugLocked) {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-xs">
                  <path fill-rule="evenodd" d="M12 1.5a5.25 5.25 0 00-5.25 5.25v3a3 3 0 00-3 3v6.75a3 3 0 003 3h10.5a3 3 0 003-3v-6.75a3 3 0 00-3-3v-3.375c0-2.9-2.35-5.25-5.25-5.25zm3.75 8.25v-3a3.75 3.75 0 10-7.5 0v3h7.5z" clip-rule="evenodd" />
                </svg>
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="icon-xs">
                  <path d="M18 1.5c2.9 0 5.25 2.35 5.25 5.25v3.75a.75.75 0 01-1.5 0V6.75a3.75 3.75 0 10-7.5 0v3a3 3 0 013 3v6.75a3 3 0 01-3 3H3.75a3 3 0 01-3-3v-6.75a3 3 0 013-3h9v-3c0-2.9 2.35-5.25 5.25-5.25z" />
                </svg>
              }
            </button>
          </div>
          <small class="hint-text">Utilisé pour l'identification unique de la forme.</small>
        </div>

        <div class="form-group full-width">
          <label for="description">Description</label>
          <textarea id="description" formControlName="description" rows="3" placeholder="Description technique ou commerciale..."></textarea>
        </div>

        <div class="form-group full-width">
          <label>Visuel de la Forme (Icône)</label>
          <div class="upload-container" (click)="fileInput.click()">
            <input #fileInput type="file" (change)="onFileSelected($event)" accept="image/*" hidden>
            
            @if (!previewUrl && !currentImageUrl) {
              <div class="upload-empty-state">
                <div class="upload-icon-circle">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="icon-lg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                  </svg>
                </div>
                <p class="upload-text"><strong>Cliquez pour charger</strong> ou glissez une image</p>
                <p class="upload-hint">PNG, JPG ou SVG (max. 2Mo)</p>
              </div>
            } @else {
              <div class="upload-preview-grid">
                @if (currentImageUrl && !previewUrl) {
                  <div class="preview-box">
                    <span class="preview-label">Actuelle</span>
                    <img [src]="currentImageUrl" alt="Actuelle" class="img-preview">
                  </div>
                }
                @if (previewUrl) {
                  <div class="preview-box highlighted">
                    <span class="preview-label">Nouvelle</span>
                    <img [src]="previewUrl" alt="Nouvelle" class="img-preview">
                    <div class="preview-overlay">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="icon-sm">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                      </svg>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </div>

        <div class="form-group full-width status-toggle-card">
          <div class="toggle-content">
            <div class="toggle-text">
              <span class="toggle-title">Visibilité du catalogue</span>
              <span class="toggle-desc">Si désactivé, cette forme ne sera pas proposée lors de la création de devis.</span>
            </div>
            <label class="switch">
              <input type="checkbox" formControlName="is_active">
              <span class="slider round"></span>
            </label>
          </div>
        </div>
      </div>

      <footer class="form-footer-actions">
        <button type="button" (click)="router.navigate(['/admin/shapes'])" class="btn-cancel">
          Annuler
        </button>
        <button type="submit" [disabled]="shapeForm.invalid || isLoading" class="btn-save">
          @if (isLoading) {
            <span class="mini-spinner"></span>
            Traitement...
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="icon-sm">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
            {{ isEditMode ? 'Enregistrer les modifications' : 'Créer la forme' }}
          }
        </button>
      </footer>
    </form>
  }
</div>